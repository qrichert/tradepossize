<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Trade Position Size Calculator</title>
    <meta name="description" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2016%2016'%3E%3Ctext%20x='0'%20y='14'%3EðŸ“ˆ%3C/text%3E%3C/svg%3E"
    />

    <style>
      :root {
        --fontSize: 16px;
        --fontSizeSmall: 0.75rem;
        --fontFamily: sans-serif;
        --defaultSpacing: 20px;
        --halfSpacing: calc(var(--defaultSpacing) / 2);
        --mainColor: white;
        --secondaryColor: #455264;
        --mainBackground: #18212b;
        --darkBackground: #101b24;
        --semiDarkBackground: #131c26b3;
        --borderRadius: 3px;
      }

      * {
        outline: none;
      }

      html {
        font-size: var(--fontSize);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        min-height: 100vh;
        margin: 0;
        padding: var(--defaultSpacing);
        display: flex;
        box-sizing: border-box;
        background-color: var(--mainBackground);
        color: white;
        font-family: var(--fontFamily);
      }

      form {
        width: 100%;
        max-width: 639px;
        margin: auto;
      }

      .formSettings {
        display: flex;
        flex-direction: row;
        justify-content: flex-end;
        font-size: var(--fontSizeSmall);
        color: var(--secondaryColor);
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }

      input[type="number"],
      input[type="text"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        font-size: var(--fontSize);
        padding: 12px 10px;
        background-color: var(--darkBackground);
        color: inherit;
        border: none;
        border-radius: var(--borderRadius);
      }

      input[type="number"][readonly],
      input[type="text"][readonly] {
        background-color: var(--semiDarkBackground);
        text-align: right;
      }

      ::placeholder {
        color: var(--secondaryColor);
      }

      input[type="radio"],
      input[type="checkbox"] {
        display: none;
      }

      input[type="radio"] + label,
      input[type="checkbox"] + label {
        padding: 4px 7px;
        border: 1px solid transparent;
        border-radius: var(--borderRadius);
      }

      input[type="radio"]:checked + label,
      input[type="checkbox"]:checked + label {
        border-color: var(--secondaryColor);
      }

      input.copy {
        cursor: copy;
      }

      hr {
        border: none;
        border-top: 1px solid var(--secondaryColor);
        width: 100%;
      }

      .info {
        font-size: var(--fontSizeSmall);
        color: var(--secondaryColor);
      }

      @media all and (max-width: 449px) {
        form {
          display: flex;
          flex-direction: column;
        }

        form > * {
          margin: 0 0 var(--halfSpacing) 0;
        }

        form > input,
        form > hr {
          margin-bottom: var(--defaultSpacing);
        }
      }

      @media all and (min-width: 450px) {
        form {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: var(--halfSpacing);
          align-items: center;
        }

        .formSettings,
        hr,
        .explanation {
          grid-column: 1 / span 2;
        }
      }
    </style>
  </head>
  <body>
    <form action="#" method="post">
      <div class="formSettings">
        <input
          type="radio"
          id="currencyUSD"
          name="currency"
          value="USD"
          data-symbol="$"
          data-display="$%{amount,.2}"
        />
        <label for="currencyUSD">USD</label>
        <input
          type="radio"
          id="currencyEUR"
          name="currency"
          value="EUR"
          data-symbol="â‚¬"
          data-display="%{amountâ€‰,2} â‚¬"
        />
        <label for="currencyEUR">EUR</label>
        <input
          type="radio"
          id="currencyBTC"
          name="currency"
          value="BTC"
          data-symbol="â‚¿"
          data-display="%{amountx.8} BTC"
        />
        <label for="currencyBTC">BTC</label>
      </div>
      <label for="totalEquity"
        >Total Equity
        <span class="info"><span class="currencySymbol"></span></span
      ></label>
      <input
        type="number"
        id="totalEquity"
        name="totalEquity"
        min="0"
        placeholder="1000.00"
      />
      <label for="riskPerTrade"
        >Risk Per Trade <span class="info">%</span></label
      >
      <input
        type="number"
        id="riskPerTrade"
        name="riskPerTrade"
        min="0"
        step=".1"
        placeholder="1.0"
      />
      <label for="amountAtRisk"
        >Amount At Risk
        <span class="info"><span class="currencySymbol"></span></span
      ></label>
      <input
        type="text"
        id="amountAtRisk"
        name="amountAtRisk"
        class="copy"
        readonly
      />
      <p
        id="riskPerTradeExplanation"
        class="info explanation"
        data-raw-str="Each trade will risk %{riskPerTrade}% of your total equity = %{amountAtRisk}"
      ></p>
      <hr />
      <label for="riskOnTrade">Risk On Trade <span class="info">%</span></label>
      <input
        type="number"
        id="riskOnTrade"
        name="riskOnTrade"
        min="0"
        step=".01"
        placeholder="3.00"
      />
      <label for="leverage">Leverage <span class="info">Ã—</span></label>
      <input
        type="number"
        id="leverage"
        name="leverage"
        min="1"
        step=".01"
        placeholder="1.00"
      />
      <label for="positionSize"
        >Position Size
        <span class="info"><span class="currencySymbol"></span></span
      ></label>
      <input
        type="text"
        id="positionSize"
        name="positionSize"
        class="copy"
        readonly
      />
      <label for="margin"
        >Margin <span class="info"><span class="currencySymbol"></span></span
      ></label>
      <input type="text" id="margin" name="margin" class="copy" readonly />
      <div class="formSettings">
        <input type="checkbox" id="autoLeverage" name="autoLeverage" />
        <label for="autoLeverage">Auto Leverage</label>
      </div>
      <p
        id="positionSizeExplanation"
        class="info explanation"
        data-raw-str="%{riskOnTrade}% of %{positionSize} (%{margin} @ %{leverage}Ã—) = %{amountAtRisk} (risk per trade)"
      ></p>
      <hr />
      <label for="winRate">Win Rate <span class="info">%</span></label>
      <input
        type="number"
        id="winRate"
        name="winRate"
        min="0"
        max="100"
        step=".1"
        placeholder="25.0"
      />
      <label for="minRrRatio"
        >Min. R/R Ratio <span class="info">R:R</span></label
      >
      <input type="text" id="minRrRatio" name="minRrRatio" readonly />
      <p
        id="winRateExplanation"
        class="info explanation"
        data-raw-str="A win rate of %{winRate}% requires at least a reward/risk ratio of %{minRrRatio} to break even"
      ></p>
    </form>
    <script>
      (function () {
        document.querySelectorAll("form").forEach((el) => {
          el.addEventListener("submit", (e) => e.preventDefault(), false);
        });

        let currencySetting = [
          ...document.querySelectorAll("input[name=currency]"),
        ];
        let autoLeverageSetting = document.getElementById("autoLeverage");
        let allSettings = [...currencySetting, autoLeverageSetting];
        let allInputs = document.querySelectorAll("input[type=number]");
        let allResults = document.querySelectorAll("input[type=text]");

        let amountAtRiskInput = document.getElementById("amountAtRisk");
        let leverageInput = document.getElementById("leverage");
        let positionSizeInput = document.getElementById("positionSize");
        let marginInput = document.getElementById("margin");
        let minRrRatioInput = document.getElementById("minRrRatio");

        document.querySelectorAll(".copy").forEach((el) => {
          el.addEventListener(
            "click",
            (e) => {
              e.preventDefault();
              if (el.dataset.rawValue) {
                navigator.clipboard.writeText(el.dataset.rawValue);
              }
            },
            false
          );
        });

        /**
         * Get selected currency as string value.
         */
        function getSelectedCurrency() {
          for (let el of currencySetting) {
            if (el.checked) {
              return el.value;
            }
          }
        }

        /**
         * Set selected currency from string value.
         */
        function setSelectedCurrency(selectedCurrency) {
          currencySetting.forEach((el) => {
            el.checked = el.value === selectedCurrency;
          });
        }

        /**
         * Get display associated with currency.
         */
        function getCurrencyDisplay() {
          let currency = getSelectedCurrency();
          let currencyDisplay = {
            symbol: "",
            format: "",
            thousandsSeparator: "",
            decimalSeparator: "",
            decimalPlaces: "",
          };
          for (let el of currencySetting) {
            if (el.value === currency) {
              let display = el.dataset.display;
              let match = /%{amount(.+?)}/.exec(display); // e.g. $%{amount,.2}
              currencyDisplay.symbol = el.dataset.symbol;
              currencyDisplay.format = display.replace(match[1], ""); // "%{amount}"
              currencyDisplay.thousandsSeparator =
                match[1][0] != "x" ? match[1][0] : ""; // ","
              currencyDisplay.decimalSeparator = match[1][1]; // "."
              currencyDisplay.decimalPlaces = parseInt(match[1][2]); // 2
              break;
            }
          }
          return currencyDisplay;
        }

        /**
         * Get auto leverage setting as boolean.
         */
        function getAutoLeverageState() {
          return autoLeverageSetting.checked;
        }

        /**
         * Set auto leverage setting from boolean.
         */
        function setAutoLeverageState(checked) {
          autoLeverageSetting.checked = checked;
        }

        /**
         * Toggle readOnly attribute of leverage.
         */
        function toggleLeverageReadOnly(readOnly) {
          leverageInput.readOnly = readOnly;
          leverageInput.type = readOnly ? "text" : "number";
        }

        /**
         * Read state from localStorage and return it.
         * If no state saved, use default values.
         */
        function loadStateFromStorage() {
          let stateFromStorage = localStorage.getItem("state");
          if (!stateFromStorage) {
            return {
              currency: "USD",
              totalEquity: 1000,
              riskPerTrade: 1,
              riskOnTrade: 3,
              leverage: 1,
              autoLeverage: false,
              winRate: 25,
            };
          }
          return JSON.parse(stateFromStorage);
        }
        let state = loadStateFromStorage();

        /**
         * Save state to localStorage.
         */
        function saveStateToStorage() {
          localStorage.setItem("state", JSON.stringify(state));
        }

        /**
         * Apply state to inputs.
         * If value missing or null -> set to 0
         */
        function updateInputsFromState() {
          setSelectedCurrency(state.currency || "USD");
          setAutoLeverageState(state.autoLeverage);
          for (let el of allInputs) {
            if (!(el.name in state) || state[el.name] === null) {
              state[el.name] = 0;
            }
            el.value = state[el.name];
          }
        }
        updateInputsFromState();

        /**
         * Update state with input values.
         */
        function updateStateFromInputs() {
          state = {}; // Clear state
          state.currency = getSelectedCurrency();
          state.autoLeverage = getAutoLeverageState();
          for (let el of allInputs) {
            state[el.name] = parseFloat(el.value);
          }
          saveStateToStorage();
        }

        /**
         * Validate inputs.
         */
        function validateInputs() {
          for (let el of allInputs) {
            // All inputs
            if (el.value < 0) {
              el.value = 0;
            }
            // Specifics
            if (el.name === "leverage") {
              if (el.value < 1) {
                el.value = 1;
              }
            } else if (el.name === "winRate") {
              if (el.value > 100) {
                el.value = 100;
              }
            }
          }
        }

        /**
         * Return number if valid and can be displayed, else return placeholder.
         */
        function sanitizeNumber(number, placeholder = 0) {
          if (Number.isNaN(number) || number === Infinity) {
            return placeholder;
          }
          return number;
        }

        /**
         * Calculate values.
         */
        function recalculateValues() {
          toggleLeverageReadOnly(state.autoLeverage);
          for (let el of allResults) {
            if (el.name === "amountAtRisk") {
              let amountAtRisk = state.totalEquity * (state.riskPerTrade / 100);
              el.value = sanitizeNumber(amountAtRisk);
            } else if (el.name === "positionSize") {
              let positionSize =
                (state.totalEquity * (state.riskPerTrade / 100)) /
                (state.riskOnTrade / 100);
              el.value = sanitizeNumber(positionSize);
              // Auto Leverage
              if (state.autoLeverage) {
                let amountAtRisk =
                  state.totalEquity * (state.riskPerTrade / 100);
                let leverage = positionSize / amountAtRisk;
                leverageInput.value = state.leverage = sanitizeNumber(leverage);
              }
            } else if (el.name === "margin") {
              let margin =
                (state.totalEquity * (state.riskPerTrade / 100)) /
                (state.riskOnTrade / 100) /
                state.leverage;
              el.value = sanitizeNumber(margin);
            } else if (el.name === "minRrRatio") {
              let minRrRatio = 1 / (state.winRate / 100) - 1;
              el.value = sanitizeNumber(minRrRatio);
            }
          }

          // Format results (styling)
          let currencyDisplay = getCurrencyDisplay();
          for (let el of [...allInputs, ...allResults]) {
            if (el.name === "totalEquity") {
              el.step = "." + "1".padStart(currencyDisplay.decimalPlaces, "0");
              el.value = parseFloat(el.value).toFixed(
                currencyDisplay.decimalPlaces
              );
            } else if (el.name === "riskPerTrade") {
              el.value = parseFloat(el.value).toFixed(1);
            } else if (
              ["amountAtRisk", "positionSize", "margin"].includes(el.name)
            ) {
              let amount = parseFloat(el.value).toFixed(
                currencyDisplay.decimalPlaces
              );
              let displayAmount = `${amount}`;
              displayAmount = displayAmount.split(".");
              displayAmount[0] = displayAmount[0].replace(
                /(\d)(?=(?:\d{3})+(?!\d))/g,
                "$1" + currencyDisplay.thousandsSeparator
              );
              displayAmount = displayAmount.join(
                currencyDisplay.decimalSeparator
              );
              displayAmount = currencyDisplay.format.replace(
                "%{amount}",
                displayAmount
              );
              el.value = displayAmount;
              el.dataset.rawValue = amount;
            } else if (el.name === "winRate") {
              el.value = parseFloat(el.value).toFixed(1);
            } else if (el.name === "minRrRatio") {
              el.value = `${Math.round(el.value * 100) / 100}:1`;
            } else {
              el.value = parseFloat(el.value).toFixed(2);
            }
          }
          document
            .querySelectorAll(".currencySymbol")
            .forEach((el) => (el.textContent = currencyDisplay.symbol));
        }

        function updateExplanations() {
          // Explanations
          for (let explanation of [
            "riskPerTradeExplanation",
            "positionSizeExplanation",
            "winRateExplanation",
          ]) {
            explanation = document.getElementById(explanation);
            let str = explanation.dataset.rawStr;
            str = explanation.dataset.rawStr;
            str = str.replace("%{amountAtRisk}", amountAtRiskInput.value);
            str = str.replace("%{riskPerTrade}", state.riskPerTrade);
            str = str.replace("%{riskOnTrade}", state.riskOnTrade);
            str = str.replace("%{positionSize}", positionSizeInput.value);
            str = str.replace("%{margin}", marginInput.value);
            str = str.replace("%{leverage}", leverageInput.value);
            str = str.replace("%{winRate}", state.winRate);
            str = str.replace("%{minRrRatio}", minRrRatioInput.value);
            explanation.textContent = str;
          }
        }

        // Save input value change to localStorage
        function updateState(e = null) {
          validateInputs();
          updateStateFromInputs();
          recalculateValues();
          updateExplanations();
        }
        updateState();

        [...allSettings, ...allInputs].forEach((el) => {
          el.addEventListener("change", (e) => updateState(e), false);
        });
      })();
    </script>
  </body>
</html>
